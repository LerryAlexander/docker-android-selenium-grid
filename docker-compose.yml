version: '3'

services:

  # test container service for holding test automation project and running the tests
  test_container:
    entrypoint: /bin/sh
    command: -c "./docker-resources/wait-for-grid.sh && ./docker-resources/wait_emulator_to_be_ready.sh && ./gradlew clean test" #wait for grid to be ready, then wait until emulators are up and running and then execute the tests
    image: framework_container
    container_name: test-container
    privileged: true
    volumes:
      - ./tests-output/testngOutput/:/docker_selenium_grid/tests-output/testngOutput/ #path to TestNG reports
      - /var/run/docker.sock:/var/run/docker.sock
    working_dir: "/docker_selenium_grid/"
    hostname: test_container_hostname
    networks:
      - docker_network
    depends_on:
      - selenium_hub
      - node_phone
      - node_tablet
    environment:
      - DOCKER_SELENIUM_PORT=4444
      - DOCKER_SELENIUM_HOST=selenium_hub
      - DOCKER_EMULATOR_PHONE=phone_container
      - DOCKER_EMULATOR_TABLET=tablet_container
    ports:
      - "8000:8000"

  # Selenium hub
  selenium_hub:
    image: selenium/hub
    container_name: selenium-hub
    hostname: selenium-hub
    networks:
      - docker_network
    environment:
      - GRID_TIMEOUT=140
      - GRID_BROWSER_TIMEOUT=120
    ports:
      - "4442-4444:4442-4444"

  # Service for Docker Android (Phone device)
  node_phone:
    image: budtmo/docker-android-x86-6.0
    container_name: phone_container
    privileged: true
    networks:
      - docker_network
    depends_on:
      - selenium_hub
    ports:
      - "6080:6080"
    volumes:
      - $PWD/docker-resources/utils.sh:/root/src/utils.sh
      - $PWD/docker-resources/supervisord.conf:/root/supervisord.conf
      - $PWD/docker-resources/appium.sh:/root/src/appium.sh
      - $PWD/docker-resources/run_app.sh:/root/src/run_app.sh
      - $PWD/docker-resources/app.py:/root/src/app.py
      - $PWD/docker-resources/generate_config.sh:/root/generate_config.sh
      - $PWD/docker-resources/start-selenium-grid-node-docker.sh:/opt/bin/start-selenium-grid-node-docker.sh
      - ./src/test/resources/TheApp-v1.8.0.apk:/root/apk/TheApp-v1.8.0.apk
      - ./tests-output/video/video-phone:/tmp/video # path to tests video execution
    environment:
      - DEVICE=Samsung Galaxy S6
      - APPIUM=true
      - AUTO_RECORD=true
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - SE_NODE_HOST=selenium-hub
      - CONNECT_TO_GRID_4=true

  # Service for Docker Android (Tablet device)
  node_tablet:
    image: budtmo/docker-android-x86-7.0
    container_name: tablet_container
    privileged: true
    networks:
      - docker_network
    depends_on:
      - selenium_hub
    ports:
      - "6081:6080"
    volumes:
      - $PWD/docker-resources/utils.sh:/root/src/utils.sh
      - $PWD/docker-resources/supervisord.conf:/root/supervisord.conf
      - $PWD/docker-resources/appium.sh:/root/src/appium.sh
      - $PWD/docker-resources/run_app.sh:/root/src/run_app.sh
      - $PWD/docker-resources/app.py:/root/src/app.py
      - $PWD/docker-resources/generate_config.sh:/root/generate_config.sh
      - $PWD/docker-resources/start-selenium-grid-node-docker.sh:/opt/bin/start-selenium-grid-node-docker.sh
      - ./src/test/resources/TheApp-v1.8.0.apk:/root/apk/TheApp-v1.8.0.apk
      - ./tests-output/video/video-tablet:/tmp/video # path to tests video execution
    environment:
      - DEVICE=Nexus 5
      - APPIUM=true
      - AUTO_RECORD=true
      - SE_EVENT_BUS_HOST=selenium-hub
      - SE_EVENT_BUS_PUBLISH_PORT=4442
      - SE_EVENT_BUS_SUBSCRIBE_PORT=4443
      - SE_NODE_HOST=selenium-hub
      - CONNECT_TO_GRID_4=true

networks:
  docker_network: